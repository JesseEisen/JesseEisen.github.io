<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      21B07 | Chan
    </title>
    <meta name="description" content="A PKM Site">
    <link rel="stylesheet" href="/assets/style.24207c44.css">
    <link rel="modulepreload" href="/assets/framework.ab59a038.js">
    <link rel="modulepreload" href="/assets/daily_21B07.md.39afec0a.lean.js">
    <link rel="modulepreload" href="/assets/app.f759e2ae.js">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    
  </head>
  <body>
    <div id="app"><div><main class="max-w-4xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="pt-6 pb-8 space-y-2 md:space-y-5"><h3 class="text-xl leading-9 font-extrabold text-gray-900 tracking-tight sm:leading-10 md:leading-14"><a aria-label="Chan" href="/">Chan</a></h3></div><!--[--><article class="xl:divide-y xl:divide-gray-200" data-v-c3fd59da><header class="pt-6 xl:pb-10 space-y-1 text-center" data-v-c3fd59da><h3 class="text-xl leading-9 font-bold text-gray-900 tracking-tigh" data-v-c3fd59da>21B07 - python hard way</h3></header><div class="prose max-w-none pt-10 pb-8" data-v-c3fd59da><p><div class="table-of-contents"><ul><li><a href="#command-line-argument-parse">command line argument parse</a></li><li><a href="#progess-bar">progess bar</a></li><li><a href="#requirements-txt">requirements.txt</a></li><li><a href="#tar-file">tar file</a></li><li><a href="#zip-file">zip file</a></li><li><a href="#subprocess">subprocess</a></li><li><a href="#sh">sh</a></li><li><a href="#format">format</a></li><li><a href="#listdir">listdir</a></li></ul></div></p><hr><h2 id="command-line-argument-parse"><a class="header-anchor" href="#command-line-argument-parse" aria-hidden="true">#</a> command line argument parse</h2><p>使用 [<a href="https://click.palletsprojects.com/en/7.x/" target="_blank" rel="noopener noreferrer">click</a>] 作为解析库，可以方便的实现子命令操作。整理一些使用中遇到的问题。</p><ul><li>对 argument 进行注释</li></ul><p>使用多行注释的方式 <code>&quot;&quot;&quot; xxx &quot;&quot;&quot;</code>。但是 click 默认是现在在统一行，去除掉了换行的操作。所以在有多参数的情况下显示比较乱。解决方式是：</p><div class="language-"><pre><code>@click.command()
@click.argument(&#39;gt&#39;, type=click.Path(exists=True))
@click.argument(&#39;prefix&#39;, type=click.Path(exists=True))
def execute(gt, prefix):
    &quot;&quot;&quot;
       \b 
       explain the command usage
       gt: xxxx
       prefix: xxxxx
    &quot;&quot;&quot;
</code></pre></div><h2 id="progess-bar"><a class="header-anchor" href="#progess-bar" aria-hidden="true">#</a> progess bar</h2><p>使用 [<a href="https://github.com/tqdm/tqdm" target="_blank" rel="noopener noreferrer">tqdm</a>] 搭配各种场景使用，比如在 requests 中显示现在的进度时，可以有如下的方式：</p><div class="language-"><pre><code>r = requests.get(url, stream=True, allow_redirects=True)
... # status code check 
path = pathlib.Path(filename).expanduser().resolve()
path.parent.mkdir(parents=True, exist_ok=True)

desc = filename.ljust(22, &#39; &#39;) # 22 is the lenght bigger than filename, should change
r.raw.read = functools.partial(r.raw.read, decode_content=True)  # Decompress if needed
with tqdm.tqdm.wrapattr(r.raw, &quot;read&quot;, total=file_size, desc=desc) as r_raw:
     with path.open(&quot;wb&quot;) as f:
            shutil.copyfileobj(r_raw, f)
</code></pre></div><p>同时也可以在命令行中使用：</p><div class="language-"><pre><code>find . -name &#39;*.py&#39; -type f -exec cat \{} \; \
  | tqdm --unit loc --unit_scale --total 857366 &gt;&gt; /dev/null
100%|█████████████████████████████████| 857K/857K [00:04&lt;00:00, 246Kloc/s]
</code></pre></div><p>更多使用参考文档 [<a href="https://tqdm.github.io/docs" target="_blank" rel="noopener noreferrer">tqdm documention</a>] 。</p><h2 id="requirements-txt"><a class="header-anchor" href="#requirements-txt" aria-hidden="true">#</a> requirements.txt</h2><p>这个文件可以用于python项目初始化时安装依赖使用。可以通过两种方式获取到：</p><div class="language-"><pre><code># 获取完整的依赖环境
$ pip3 freeze &gt; requirements.txt

# 获取必要的依赖
$ pip install pipreqs
$ pipreqs .

# 使用
$ pip install -r requirements.txt
</code></pre></div><h2 id="tar-file"><a class="header-anchor" href="#tar-file" aria-hidden="true">#</a> tar file</h2><p>获取 tar.gz 文件中的顶层目录的名称，使用下面简单的方式：</p><div class="language-"><pre><code>archive = tarfile.open(filepath, mode=&#39;r&#39;)
print os.path.commonprefix(archive.getnames())
</code></pre></div><h2 id="zip-file"><a class="header-anchor" href="#zip-file" aria-hidden="true">#</a> zip file</h2><p>使用 zipfile 库，更加灵活的打包 zip 包。</p><div class="language-"><pre><code>from zipfile import ZipFile

with ZipFile(&#39;target.zip&#39;, &#39;w&#39;) as newzip:
    newzip.write(&#39;directory_name&#39;)
    newzip.write(&#39;file_name&#39;)
</code></pre></div><p>使用 shutil 中的 make_archive 函数生成的包有点奇怪(?)，不如使用 zipfile 来的灵活。</p><h2 id="subprocess"><a class="header-anchor" href="#subprocess" aria-hidden="true">#</a> subprocess</h2><p>使用 subprocess 时，往往需要添加子进程中的环境变量，可以使用:</p><div class="language-"><pre><code>import subprocess, os
my_env = os.environ.copy()
my_env[&quot;PATH&quot;] = &quot;/usr/sbin:/sbin:&quot; + my_env[&quot;PATH&quot;]
subprocess.Popen(my_command, env=my_env)
</code></pre></div><h2 id="sh"><a class="header-anchor" href="#sh" aria-hidden="true">#</a> sh</h2><p>sh is a full-fledged subprocess replacement for Python 2.6 - 3.8, PyPy and PyPy3 that allows you to call any program as if it were a function.</p><div class="language-"><pre><code>import sh
# like command run in bash. $ sed -i &#39;s/a/A/g&#39; filename
sh.sed([&#39;-i&#39;, f&#39;s/a/A/g&#39;, filename]}&#39;])
</code></pre></div><h2 id="format"><a class="header-anchor" href="#format" aria-hidden="true">#</a> format</h2><p>python 中用于格式的操作，在格式化数字的时候，可以方便的控制小数点后的面位数。具体的可以参考[<a href="https://docs.python.org/3/library/string.html#format-examples" target="_blank" rel="noopener noreferrer">string format</a>]</p><div class="language-"><pre><code>&quot;{:.2f}&quot;.format(13.949999999999999)
</code></pre></div><h2 id="listdir"><a class="header-anchor" href="#listdir" aria-hidden="true">#</a> listdir</h2><p>python 中遍历目录有好几种方式，不同的方式满足于不同的场景。</p><ul><li>os.listdir</li></ul><p>列举出当前目录下所有的文件，同时我们可以通过文件类型去进行过滤。比如：</p><div class="language-"><pre><code>import os 

files = [f for f in os.listdir(&#39;.&#39;) if os.path.isfile(f)]
dirs = [d for d in os.listdir(&#39;.&#39;) if os.path.isdir(d)]
</code></pre></div><ul><li>os.walk</li></ul><p>walk 一般会递归去获取当前目录下所有的文件包含子目录，需要通过指定一些配置来满足我们的需求。简单的使用如下：</p><div class="language-"><pre><code>import os

for root, dirs, files in os.walk(&#39;.&#39;, topdown=True):
    dirs.clear()
    for file in files:
        print(file)
</code></pre></div><p><code>dirs.clear()</code> 用于不递归遍历当前目录下的子目录。 如果不删除，则会显示当前目录下所有的文件包含子目录里面的文件。这需要结合具体的场景。</p><ul><li>find(shell command with subprocess)</li></ul><p>这种方式是结合了 shell 的一些特性，一般不得以的情况下才使用。</p></div></article><footer class="text-right my-12" data-v-c3fd59da><p class="author-show" data-v-c3fd59da>L.K</p></footer><!--]--></main></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"4ba7c645\",\"daily_20d10.md\":\"ca3edd83\",\"daily_20q01.md\":\"6dfd4483\",\"daily_20x11.md\":\"16c672b8\",\"daily_21b04.md\":\"061190bb\",\"daily_21b05.md\":\"e11b2b95\",\"daily_21b06.md\":\"9363a8c2\",\"daily_21b07.md\":\"39afec0a\",\"daily_21b11.md\":\"5b41b59e\",\"daily_21b12.md\":\"4c306d93\",\"daily_21c04.md\":\"a882783a\",\"daily_21d09.md\":\"7541a9c0\",\"daily_21d13.md\":\"cffd3403\",\"daily_21d14.md\":\"de8825ae\",\"daily_21eo8.md\":\"2c2dc784\",\"daily_21f03.md\":\"af88893b\",\"daily_21f06.md\":\"3b89681a\",\"daily_21f08.md\":\"1eed810e\",\"daily_21f11.md\":\"84e47fdf\",\"daily_21f13.md\":\"ff550821\",\"posts_19x14.md\":\"74b0704d\",\"posts_20e01.md\":\"610cf89c\",\"posts_draw.md\":\"40330124\",\"posts_first_post.md\":\"1eb64573\",\"posts_openssl.md\":\"93f5bec6\",\"posts_tpp.md\":\"b532556d\"}")</script>
    <script type="module" async src="/assets/app.f759e2ae.js"></script>
  </body>
</html>