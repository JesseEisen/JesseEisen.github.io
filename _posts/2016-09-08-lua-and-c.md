---
title: Lua Install and Called by C
updated: 2016-09-08 19:00
---

## 安装Lua

Lua安装我采用的是源码安装,因为Lua的源码ANSI C实现的,所以编译时不需要依赖什么,所以源码安装不是很费力气的.
基本步骤如下:(Lua5.3.3)

```bash
curl -R -O http://www.lua.org/ftp/lua-5.3.3.tar.gz
tar zxf lua-5.3.3.tar.gz
cd lua-5.3.3
make linux install
```

最后一步install时,需要管理员权限,需要注意下. 这个安装我们会看到如下的信息:

```bash
cd src && mkdir -p /usr/local/bin /usr/local/include /usr/local/lib /usr/local/man/man1 /usr/local/share/lua/5.3 /usr/local/lib/lua/5.3
cd src && install -p -m 0755 lua luac /usr/local/bin
cd src && install -p -m 0644 lua.h luaconf.h lualib.h lauxlib.h lua.hpp /usr/local/include
cd src && install -p -m 0644 liblua.a /usr/local/lib
cd doc && install -p -m 0644 lua.1 luac.1 /usr/local/man/man1
```

我们可以看到生成了`lua`,`luac`,`liblua.a`.分别将这些放到了对应的文件夹下.我们可以测试一下安装是否成功:

```bash
$ lua -v
Lua 5.3.3  Copyright (C) 1994-2016 Lua.org, PUC-Rio
```

出现此信息,则表明安装成功.但是我们发现生成的`liblua.a`这个静态链接文件, 如果我们需要生成一个`.so`的动态文件,需要手动修改一下Makefile.

### 动态链接库生成

这个过程也是比较简单的, 首先在`lua-5.3.3/src/Makefile`中对应的位置添加如下规则:

```bash
#添加新语句
LUA_SO=liblua.so

#添加 -fPIC
CFLAGS= -O2 -Wall -Wextra -DLUA_COMPAT_5_2 $(SYSCFLAGS) -fPIC $(MYCFLAGS)

#修改源ALL_T为
ALL_T = $(LUA_A) $(LUA_T) $(LUAC_T) $(LUA_SO)

#添加
$(LUA_SO): $(CORE_O) $(LIB_O)
     $(CC) -o $@ -shared $? -ldl -lm
```

保存退出,打开`lua-5.3.3/Makefile`,修改如下语句

```
#添加 liblua.so
TO_LIB=liblua.a liblua.so
```

此时重新编译安装,便能生成`.so`文件. 至此基本安装到此结束,如果你有其他的需要的话,可以参考[lua5.3doc by 云风](http://cloudwu.github.io/lua53doc/)

## C调用lua

这部分不会很详细的介绍如何去使用Lua C API,只是介绍如何编译调用lua脚本的C程序. 首先我们写一个demo:

```lua
#hello.lua
print "This is in lua"
```

接着是一个简单的, `hello.c`:

```c
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>

#include <stdio.h>
#include <stdlib.h>

void err(lua_State *L, char *msg)
{
    fprintf(stderr, "\nFATAL Error:\n %s:%s\n",msg,lua_tostring(L,-1));
    exit(1);
}

int main(void)
{
    lua_State *L;

    L = luaL_newstate(); /*create a lua state variable*/
    luaL_openlibs(L);    /*load Lua libraries*/

    if(luaL_loadfile(L,"hello.lua")) /*load but not run the lua script*/
        err(L,"luaL_loadfile() failed");

    printf("In C, calling Hello.lua\n");

    if(lua_pcall(L,0,0,0))  /*run the loaded Lua script*/
        err(L,"lua_pcall() failed");

    printf("Now back in C\n");

    lua_close(L);  

    return 0;
}
```

如果你是通过源码安装的,可以通过下面的方式来编译这段代码,可以利用静态的`.a`或者动态的`.so`进行编译.

### 通过静态文件

```bash
gcc hello.c /usr/local/lib/liblua.a -o hello -lm -ldl
```

缺少`-lm` 则有关数学计算的相关函数就会报错.比如:

```bash
/usr/local/lib/liblua.a(lobject.o): In function numarith.isra.0':
lobject.c:(.text+0x1b3): undefined reference to fmod'
lobject.c:(.text+0x1d9): undefined reference to pow'
lobject.c:(.text+0x1ed): undefined reference to floor'
......
```

缺少`-ldl`则会报如下错误:

```bash
/usr/local/lib/liblua.a(loadlib.o): In function lookforfunc':
loadlib.c:(.text+0x524): undefined reference to dlsym'
loadlib.c:(.text+0x571): undefined reference to dlerror'
loadlib.c:(.text+0x5a6): undefined reference to dlopen'
loadlib.c:(.text+0x61f): undefined reference to dlerror'
/usr/local/lib/liblua.a(loadlib.o): In function gctm':
loadlib.c:(.text+0x7d1): undefined reference to dlclose'
collect2: error: ld returned 1 exit status
```

### 通过动态文件

```bash
 gcc -g -o hello hello.c -I/usr/local/include -llua
```

指定头文件目录以及`-llua`即可. 


如果你的找不到lua.h等头文件的路径,可以使用如下命令进行查找:

```bash
sudo updatedb
locate /lua.h
```

同理,`liblua.a`等找不到,也可利用这个方法来查找. 


### 参考链接
[1.编译源码](http://kiya.space/2016/08/31/compile-lua-5-3-3/)
[2.编译问题总结](http://blog.csdn.net/wangbin579/article/details/7265405)
