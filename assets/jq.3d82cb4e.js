import{_ as s}from"./app.1e82055a.js";import{h as a,o as n,a as e,w as t,b as o,k as l}from"./vendor.5a394a79.js";const c=o("div",null,[o("p",null,"日常编写 bash 脚本处理 json 时，我们大概率会使用 jq 这个工具，此时我们需要学习一些 jq 的语法，下面总结一些使用过程中遇到的一些问题和解决方式。"),o("h3",{id:"使用-bash-变量"},[o("a",{class:"header-anchor",href:"#使用-bash-变量","aria-hidden":"true"},"#"),l(" 使用 bash 变量")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l("$ "),o("span",{class:"token assign-left variable"},"var1"),o("span",{class:"token operator"},"="),o("span",{class:"token string"},'"hello"'),l("\n$ jq --arg var1 "),o("span",{class:"token variable"},"$var1"),l(),o("span",{class:"token string"},[l("'.res["),o("span",{class:"token variable"},"$var1"),l("]'")]),l(" filename.json\n")])]),o("p",null,[l("可以多次使用 "),o("code",null,"--arg inner_var bash_var"),l(" 的方式。")]),o("h3",{id:"检查-key-是否存在"},[o("a",{class:"header-anchor",href:"#检查-key-是否存在","aria-hidden":"true"},"#"),l(" 检查 key 是否存在")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l("$ jq -r "),o("span",{class:"token string"},"'.result | has(\"keyname\")'"),l(" filename.json\n"),o("span",{class:"token boolean"},"true"),l("  "),o("span",{class:"token comment"},"# or false"),l("\n")])]),o("h3",{id:"检查字段是否存在某些字段"},[o("a",{class:"header-anchor",href:"#检查字段是否存在某些字段","aria-hidden":"true"},"#"),l(" 检查字段是否存在某些字段")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l("$ jq -r "),o("span",{class:"token string"},"'.result.var | contains(\"content\")'"),l(" filename.json\n"),o("span",{class:"token boolean"},"true"),l(),o("span",{class:"token comment"},"# or false"),l("\n")])]),o("h3",{id:"获取-object-的-key-或者-value"},[o("a",{class:"header-anchor",href:"#获取-object-的-key-或者-value","aria-hidden":"true"},"#"),l(" 获取 object 的 key 或者 value")]),o("p",null,"比如有如下的 json :"),o("pre",{class:"language-json"},[o("code",{class:"language-json"},[o("span",{class:"token punctuation"},"{"),l("\n  "),o("span",{class:"token property"},'"key1"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n    "),o("span",{class:"token property"},'"key11"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n      "),o("span",{class:"token property"},'"key111"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n        "),o("span",{class:"token property"},'"key1111"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token string"},'"hello"'),l("\n      "),o("span",{class:"token punctuation"},"}"),l("\n    "),o("span",{class:"token punctuation"},"}"),l("\n  "),o("span",{class:"token punctuation"},"}"),o("span",{class:"token punctuation"},","),l("\n  "),o("span",{class:"token property"},'"key2"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n    "),o("span",{class:"token property"},'"key22"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n      "),o("span",{class:"token property"},'"key222"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n        "),o("span",{class:"token property"},'"key2222"'),o("span",{class:"token operator"},":"),l(),o("span",{class:"token string"},'"world"'),l("\n      "),o("span",{class:"token punctuation"},"}"),l("\n    "),o("span",{class:"token punctuation"},"}"),l("\n  "),o("span",{class:"token punctuation"},"}"),l("\n"),o("span",{class:"token punctuation"},"}"),l("\n")])]),o("p",null,[l("若只想输入两个 value 的值，"),o("code",null,"hello"),l(" 和 "),o("code",null,"world"),l("。 可以用的方式是：")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l("$ jq -r "),o("span",{class:"token string"},"'.[] | .[] | .[] | to_entries | .[].value'"),l(" xxx.json\nhello\nworld\n")])]),o("p",null,[l("注意这边的 "),o("code",null,"to_entries"),l(" 是将内容转变成固定格式：")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[o("span",{class:"token punctuation"},"["),l("\n  "),o("span",{class:"token punctuation"},"{"),l("\n    "),o("span",{class:"token string"},'"key"'),o("span",{class:"token builtin class-name"},":"),l(),o("span",{class:"token string"},'"key111"'),l(",\n    "),o("span",{class:"token string"},'"value"'),o("span",{class:"token builtin class-name"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n      "),o("span",{class:"token string"},'"key1111"'),o("span",{class:"token builtin class-name"},":"),l(),o("span",{class:"token string"},'"hello"'),l("\n    "),o("span",{class:"token punctuation"},"}"),l("\n  "),o("span",{class:"token punctuation"},"}"),l("\n"),o("span",{class:"token punctuation"},"]"),l("\n"),o("span",{class:"token punctuation"},"["),l("\n  "),o("span",{class:"token punctuation"},"{"),l("\n    "),o("span",{class:"token string"},'"key"'),o("span",{class:"token builtin class-name"},":"),l(),o("span",{class:"token string"},'"key222"'),l(",\n    "),o("span",{class:"token string"},'"value"'),o("span",{class:"token builtin class-name"},":"),l(),o("span",{class:"token punctuation"},"{"),l("\n      "),o("span",{class:"token string"},'"key2222"'),o("span",{class:"token builtin class-name"},":"),l(),o("span",{class:"token string"},'"world"'),l("\n    "),o("span",{class:"token punctuation"},"}"),l("\n  "),o("span",{class:"token punctuation"},"}"),l("\n"),o("span",{class:"token punctuation"},"]"),l("\n")])]),o("p",null,"之后再统一取指定的 key 下面的内容。"),o("h3",{id:"jq-读取-array-内容到-bash-变量"},[o("a",{class:"header-anchor",href:"#jq-读取-array-内容到-bash-变量","aria-hidden":"true"},"#"),l(" jq 读取 array 内容到 bash 变量")]),o("p",null,"我们经常需要将 json 的数组内容读取到 bash 的数组中。可以有两种方式，主要看 bash 的版本："),o("ul",null,[o("li",null,"bash 4+")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l("$ "),o("span",{class:"token builtin class-name"},"mapfile"),l(" -t arr "),o("span",{class:"token operator"},"<"),l(),o("span",{class:"token operator"},"<"),o("span",{class:"token punctuation"},"("),l("jq -r "),o("span",{class:"token string"},"'keys[]'"),l(" xxx.json"),o("span",{class:"token punctuation"},")"),l("\n")])]),o("ul",null,[o("li",null,"older bash")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[o("span",{class:"token assign-left variable"},"arr"),o("span",{class:"token operator"},"="),o("span",{class:"token punctuation"},"("),o("span",{class:"token punctuation"},")"),l("\n"),o("span",{class:"token keyword"},"while"),l(),o("span",{class:"token assign-left variable"},[o("span",{class:"token environment constant"},"IFS")]),o("span",{class:"token operator"},"="),o("span",{class:"token string"},"''"),l(),o("span",{class:"token builtin class-name"},"read"),l(" -r line"),o("span",{class:"token punctuation"},";"),l(),o("span",{class:"token keyword"},"do"),l("\n   "),o("span",{class:"token assign-left variable"},"arr"),o("span",{class:"token operator"},"+="),o("span",{class:"token punctuation"},"("),o("span",{class:"token string"},[l('"'),o("span",{class:"token variable"},"$line"),l('"')]),o("span",{class:"token punctuation"},")"),l("\n"),o("span",{class:"token keyword"},"done"),l(),o("span",{class:"token operator"},"<"),l(),o("span",{class:"token operator"},"<"),o("span",{class:"token punctuation"},"("),l("jq "),o("span",{class:"token string"},"'keys[]'"),l(" xxx.json"),o("span",{class:"token punctuation"},")"),l("\n")])]),o("p",null,"此外还有一种方式用于纯 json 数组的转换，比如："),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[o("span",{class:"token comment"},"#["),l("\n"),o("span",{class:"token comment"},"#    1, 2, 3, 4, 5, 6, 7, 8, 9"),l("\n"),o("span",{class:"token comment"},"#]"),l("\n\n$ "),o("span",{class:"token assign-left variable"},"arr"),o("span",{class:"token operator"},"="),o("span",{class:"token punctuation"},"("),o("span",{class:"token variable"},[o("span",{class:"token variable"},"$("),l("jq -r "),o("span",{class:"token string"},"'. | @sh'"),l(" xxx.json"),o("span",{class:"token variable"},")")]),o("span",{class:"token punctuation"},")"),l("\n")])]),o("blockquote",null,[o("p",null,"@sh: The input is escaped suitable for use in a command-line for a POSIX shell. If the input is an array, the output will be a series of space-separated strings.")]),o("h3",{id:"jq-输出多字段内容读取到-bash-变量中"},[o("a",{class:"header-anchor",href:"#jq-输出多字段内容读取到-bash-变量中","aria-hidden":"true"},"#"),l(" jq 输出多字段内容读取到 bash 变量中")]),o("p",null,"当我们同时需要读取两个并列的 json 字段的内容到脚本中同时处理时，这个过程稍微有点复杂。"),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l(" jq -r "),o("span",{class:"token string"},"'. | [.name,.value] | @tsv'"),l(" model_info.json "),o("span",{class:"token operator"},"|"),l(),o("span",{class:"token punctuation"},"\\"),l("\n        "),o("span",{class:"token keyword"},"while"),l(),o("span",{class:"token assign-left variable"},[o("span",{class:"token environment constant"},"IFS")]),o("span",{class:"token operator"},"="),l("$"),o("span",{class:"token string"},[l("'"),o("span",{class:"token entity",title:"\\t"},"\\t"),l("'")]),l(),o("span",{class:"token builtin class-name"},"read"),l(" -r name ctx"),o("span",{class:"token punctuation"},";"),l(),o("span",{class:"token keyword"},"do"),l("\n           "),o("span",{class:"token builtin class-name"},"echo"),l(),o("span",{class:"token variable"},"$name"),l(", "),o("span",{class:"token variable"},"$ctx"),l("\n        "),o("span",{class:"token keyword"},"done"),l("\n\n")])]),o("blockquote",null,[o("p",null,"@tsv: The input must be an array, and it is rendered as TSV (tab-separated values). Each input array will be printed as a single line. Fields are separated by a single tab (ascii 0x09). Input characters line-feed (ascii 0x0a), carriage-return (ascii 0x0d), tab (ascii 0x09) and backslash (ascii 0x5c) will be output as escape sequences \\n, \\r, \\t, \\ respectively.")]),o("p",null,"总体的思路就是先转成 tsv 格式，后续在 read 指定分隔符读取。"),o("h3",{id:"join-指定字段内容"},[o("a",{class:"header-anchor",href:"#join-指定字段内容","aria-hidden":"true"},"#"),l(" join 指定字段内容")]),o("p",null,[l("join 是使用指定分隔符去合并相应的数组内容，比如有数组： "),o("code",null,"[1,2,3,4,5]")]),o("pre",{class:"language-bash"},[o("code",{class:"language-bash"},[l("$ jq -r "),o("span",{class:"token string"},"'.|join(\"|\")'"),l(" arr.json\n"),o("span",{class:"token number"},"1"),o("span",{class:"token operator"},"|"),o("span",{class:"token number"},"2"),o("span",{class:"token operator"},"|"),o("span",{class:"token number"},"3"),o("span",{class:"token operator"},"|"),o("span",{class:"token number"},"4"),o("span",{class:"token operator"},"|"),o("span",{class:"token number"},"5"),l("\n")])])],-1),p={expose:[],setup(o){const l={title:"jq in action",date:"2022-05-11T00:00:00.000Z",author:"Linkang Chan",twitter:"JessEisen_LJ",description:"jq use with bash",public:!0,tag:"22J05 jq",meta:[{property:"og:title",content:"jq in action"},{property:"og:description",content:"jq use with bash"},{name:"description",content:"jq use with bash"}]};return a({title:"jq in action",meta:[{property:"og:title",content:"jq in action"},{property:"og:description",content:"jq use with bash"},{name:"description",content:"jq use with bash"}]}),(a,o)=>{const p=s;return n(),e(p,{frontmatter:l},{default:t((()=>[c])),_:1})}}};export default p;
